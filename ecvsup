#!/bin/bash
#
# Sync portage tree via CVS
#

USAGE="[-hfn]"
LONGUSAGE="\t-h\tPrint this help message
\t-f\tFast update (no metadata regen)
\t-n\tSkip updating overlays"

# Standard functions
source ${HOME}/bin/scripts/functions.sh

# PORTDIR and PORTDIR_OVERLAY
source /etc/make.globals
source /etc/make.conf

# Parse arguments
while getopts ":hfn" option; do
       case ${option} in
               f ) FAST="yes";;
               n ) NOOVERLAYS="yes";;
               h ) usage;;
               \? ) usage "Invalid argument ${OPTARG}";;
               * ) usage "Invalid argument ${option}";;
       esac
done

cd ${PORTDIR} || die "no ${PORTDIR}"
# Removed -C, because it touches mtime of every file, causing a full regen
cvs -q up -PdA || die "cvs up failed"
find ${PORTDIR} -name '.#*' -exec rm {} \; || die "find .#* failed"
if [ -z "${NOOVERLAYS}" ]; then
	for i in ${PORTDIR_OVERLAY}; do
		cd ${i}
		vcs_detect
		vcs_update
	done
fi
if [ -z "${FAST}" ]; then
	sudo emerge --regen || die "emerge regen failed"
	sudo emerge --metadata || die "emerge metadata failed"
fi
